---
title: "Как получить системную информацию о файле или директории в Node.js (stat)"
timestamp: 2015-02-11T14:30:01
tags:
  - stat
  - fs.Stats
  - isFile
  - isDirectory
  - size
published: true
books:
  - nodejs
author: szabgab
translator: name2rnd
archive: true
original: system-information-about-a-file-or-directory-in-nodejs
---


Команда `ls` в ОС Unix/Linux может предоставить информацию о файле, директории, символьной ссылке и о прочих элементах, которые могут существовать в файловой системе. С помощью флага `-l` можно увидеть тип просматриваемого элемента (файл/директория/символьная ссылка...), независимо от того, какие права для него установлены - на чтение, запись или исполнение.

В основном, эту информацию можно получить из структуры [inode](http://en.wikipedia.org/wiki/Inode), но не в Node.js под Apple.

Прежде чем попробовать заново реализовать UNIX команду ls, давайте посмотрим, что мы можем узнать про элемент файловой системы с помощью Node.js


Библиотека [fs](http://nodejs.org/api/fs.html), поставляющаяся вместе с Node.js, предоставляет асинхронный метод [stat](http://nodejs.org/api/fs.html#fs_fs_stat_path_callback), который получает первым аргументом путь к элементу файловой системы, находит информацию о нем в <b>inode</b>, затем вызывает функцию-коллбек (обратный вызов, переданный вторым аргументом). В коллбек будет передан объект [fs.Stats](http://nodejs.org/api/fs.html#fs_class_fs_stats).

Так же есть синхронная версия этого метода [statSync](http://nodejs.org/api/fs.html#fs_fs_statsync_path), которая вернет объект [fs.Stats](http://nodejs.org/api/fs.html#fs_class_fs_stats), когда будет завершено чтение информации из файловой системы.

Эта программа показывает, как использовать асинхронный метод:

{% include file="examples/node/stats.js" %}

Предполагается, что эта программа вызывается таким образом: `node examples/node/stats.js path/to/file`.

Для примера я запустил `node examples/node/stats.js examples` (указав в качестве параметра директорию 'examples') и получил такой результат:

```
examples

{ dev: 16777220,
  mode: 16877,
  nlink: 11,
  uid: 501,
  gid: 20,
  rdev: 0,
  blksize: 4096,
  ino: 32548075,
  size: 374,
  blocks: 0,
  atime: Sat Jan 31 2015 10:56:30 GMT+0200 (IST),
  mtime: Sat Jan 31 2015 10:52:13 GMT+0200 (IST),
  ctime: Sat Jan 31 2015 10:52:13 GMT+0200 (IST) }

    directory
    size: 374
    mode: 16877
    others eXecute: x
    others Write:   -
    others Read:    r
    group eXecute:  x
    group Write:    w
    group Read:     r
    owner eXecute:  x
    owner Write:    w
    owner Read:     r
    file:           -
    directory:      d
```

Сравним полученную информацию с результатом работы команды `ls`:

```
$ ls -ld examples
drwxr-xr-x  11 gabor  staff  374 Jan 31 10:52 examples
```

Давайте разберем нашу программу:

```javascript
var fs = require('fs');

if (process.argv.length <= 2) {
    console.log("Usage: " + __filename + " path/to");
    process.exit(-1);
}

var path = process.argv[2];
```

После загрузки библиотеки `fs` мы проверяем количество [аргументов, полученных через командную строку](/argv-raw-command-line-arguments-in-nodejs). Если их 2 или меньше (я не уверен, что меньше двух вообще возможно), значит пользователь вообще не передал никаких аргументов.
(Если пользователь выполнил `node examples/node/stats.js`, тогда мы получим два аргумента). В этом случае мы выводим пользователю подсказку:

```
$ node examples/node/stats.js
Usage: /home/gabor/code-maven/examples/node/stats.js path/to
```

Глобальная переменная `__filename` (начинается с двух подчеркиваний) содержит полный путь к текущему выполняемому файлу.
Затем вызываем `process.exit()` для [немедленного завершения работы](/how-to-exit-a-nodejs-script).

Последний шаг в этом фрагменте кода - получаем третий элемент (его индекс равен 2) из `argv`, который содержит значение, переданное пользователем в командной строке, и присваиваем его переменной `path`.

## Вызов fs.stat

Затем мы вызвали метод [stat](http://nodejs.org/api/fs.html#fs_fs_stat_path_callback), передав в него `path` и функцию-коллбек. Эта функция получит объект ошибки (если она случится) и объект [fs.Stats](http://nodejs.org/api/fs.html#fs_class_fs_stats)

```javascript
fs.stat(path, function(err, stats) {
```

Объект `Stats` содержит данные, полученные из inode (в нашем случае это выглядит так:)

```
{ dev: 16777220,
  mode: 16877,
  nlink: 11,
  uid: 501,
  gid: 20,
  rdev: 0,
  blksize: 4096,
  ino: 32548075,
  size: 374,
  blocks: 0,
  atime: Sat Jan 31 2015 10:56:30 GMT+0200 (IST),
  mtime: Sat Jan 31 2015 10:52:13 GMT+0200 (IST),
  ctime: Sat Jan 31 2015 10:52:13 GMT+0200 (IST) }
```

Кроме этого, `Stats` предоставляет несколько методов для большего удобства.

Мы получили набор данных, где `dev` - номер устройства. Это может быть полезным, если у вас несколько разделов или физических дисков.

`mode` содержит много информации, включая тип элемента (файл/директория/символьная ссылка) и права доступа.

`uid` - идентификатор владельца элемента.

`gid` - идентификатор группы владельца.

`size` - размер в байтах.

`atime`, `mtime`, и `ctime` - время последнего доступа, изменения и создания элемента.

Прежде, чем мы начнем детально разбираться с `mode`, давайте рассмотрим несколько вспомогательных функций:

`isFile()` вернет `True`, если это файл.

`isDirectory()` вернет `True`, если это директория.

В [документации по fs.Stat](http://nodejs.org/api/fs.html#fs_class_fs_stats) перечислены еще несколько подобных функций.

Обратиться к остальным значениям можно обычным для JavaScript способом:
К примеру, вот так можно получить значение для 'size':

## Размер файла в Node.js

```javascript
console.log('    size: ' + stats["size"]);
```

## Права доступа к файлу

Раздел документации [man 2 stat](http://man7.org/linux/man-pages/man2/stat.2.html) описывает, как трактовать значение `mode`, которое в нашем случае равно 16877.

Нам нужно использовать специальные битовые маски, чтобы определить, установлены ли нужные нам биты в 0 или в 1.
Например, `mode & 1` будет равно 1, если правый бит в `mode` установлен в 1. 

`mode & 2` будет равно 2, если второй бит справа установлен в 1, и 0, если это не так.

`mode & 4` будет равно 4, если третий (!) бит справа установлен в 1, и 0, если нет. 

К счастью JavaScript все числа, кроме 0, рассматривает как True. Таким образом, мы можем использовать тернарный оператор `?:` для возврата каких-нибудь подходящих символов, если значение выражения отлично от 0, и возвращать `-` если оно равно 0.

Таким образом, мы можем выводить символы `rwx-` по аналогии с командой `ls -ld`.

Кроме прав доступа на файл из `mode` мы можем получить тип файла, но для этого у нас есть более удобный способ, описанный выше.
